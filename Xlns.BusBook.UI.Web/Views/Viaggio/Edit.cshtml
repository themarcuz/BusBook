@using Xlns.BusBook.UI.Web.Models;
@model Xlns.BusBook.Core.Model.Viaggio
@{
    ViewBag.Title = "Edit";
}
@{
    if (Model.Id == 0)
    {
        ViewBag.Title = "Nuovo viaggio";
    }
    else
    {
        ViewBag.Title = "Modifica viaggio";
    }
}
@section scripts{
    <script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $(".datepicker").datepicker(
                                    {
                                        dateFormat: "dd M yy"
                                    });
        });
    </script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
}
<div id="content-wrapper" class="container_16">
    <div id="main" class="grid_16">
        <h3>
            @ViewBag.Title</h3>
        <div style="display: table">
            <div style="display: table-row">
                <div style="display: table-cell">
                    @using (Html.BeginForm("Save", "Viaggio", FormMethod.Post, new { id = "salvaViaggioForm" }))
                    {
                        @Html.ValidationSummary(true)
                        <fieldset>
                            <div class="editor-label">
                                @Html.LabelFor(model => model.Nome)
                            </div>
                            <div class="editor-field">
                                @Html.TextBoxFor(model => model.Nome, new { style = "width: 300px" })
                                @Html.ValidationMessageFor(model => model.Nome)
                            </div>
                            <div class="editor-label">
                                @Html.LabelFor(model => model.Descrizione)
                            </div>
                            <div class="editor-field">
                                @Html.TextAreaFor(model => model.Descrizione, 3, 50, null)
                                @Html.ValidationMessageFor(model => model.Descrizione)
                            </div>
                            <div class="editor-label">
                                @Html.LabelFor(model => model.DataPartenza)
                            </div>
                            <div class="editor-field">
                                @Html.TextBox("DataPartenza", string.Format(ModelMetadata.FromLambdaExpression(m => m.DataPartenza, ViewData).DisplayFormatString, Model.DataPartenza), new { @class = "datepicker" })
                                @Html.ValidationMessageFor(model => model.DataPartenza)
                            </div>
                            <div class="editor-label">
                                @Html.LabelFor(model => model.DataChiusuraPrenotazioni)
                            </div>
                            <div class="editor-field">
                                @Html.TextBox("DataChiusuraPrenotazioni", string.Format(ModelMetadata.FromLambdaExpression(m => m.DataChiusuraPrenotazioni, ViewData).DisplayFormatString, Model.DataChiusuraPrenotazioni), new { @class = "datepicker" })
                                @Html.ValidationMessageFor(model => model.DataChiusuraPrenotazioni)
                            </div>
                            @Html.HiddenFor(model => model.Id)
                            <p>
                                <input type="submit" value="Salva" class="button" />
                                <input type="button" value="Annulla" id="cancelButton" class="button" 
                                    onclick="window.location='@Href("~/Viaggio/List")'" />
                            </p>
                        </fieldset>
                    }
                </div>
                <div style="display: table-cell; padding-left: 50px">
                    @if (Model.Id != 0)
                    {
                        <div id="ListaTappeEditabili">
                            @{Html.RenderAction("EditTappeViaggio", new { idViaggio = Model.Id });
                            }                           
                        </div>
                        <div id="EditTappaDialog" style="display: none">
                           
                        </div>
                        <script type="text/javascript">
                            var tappaDialog;
                           
                            function ShowLoadingElement() {
                                $('#ListaTappeEditabili').html('<img alt="loading" src="@Url.Content("~/Content/img/loading.gif")" width="24px" height="24px"/>');
                            }

                            function CloseDialog() {
                                tappaDialog.dialog("close");
                            }

                            $(function () {                                
                                tappaDialog = $('#EditTappaDialog');
                                tappaDialog.dialog(
                                {
                                    modal: true,
                                    autoOpen: false,
                                    width: '800',
                                    resizable: false
                                });
                            });
                            function aggiungiTappa(tipoTappa) {
                                $.ajax({
                                    url: '@Url.Action("CreateTappa")' + "?tipo=" + tipoTappa + "&idViaggio=@Model.Id",
                                    cache: false,
                                    success: function (result) {
                                        tappaDialog.html(result);
                                        $('#submitButton').show();
                                        tappaDialog.dialog("open");
                                    },
                                    failure: function () {
                                        tappaDialog.html("Impossibile recuperare l'editor delle tappe");
                                        $('#submitButton').hide();
                                    }
                                });
                            }

                            function modificaTappa(idTappa){
                                $.ajax({
                                    url: '@Url.Action("EditTappa")' + "?id=" + idTappa,
                                    cache: false,
                                    success: function (result) {
                                        tappaDialog.html(result);
                                        $('#submitButton').show();
                                        tappaDialog.dialog("open");
                                    },
                                    failure: function () {
                                        tappaDialog.html("Impossibile recuperare l'editor delle tappe");
                                        $('#submitButton').hide();
                                    }
                                });
                            }
                        </script>

                    }
                </div>
            </div>
        </div>
    </div>
</div>
